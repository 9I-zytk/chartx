KISSY.add("dvix/components/pie/Pie",function(a,b,c,d,e,f,g){var h=function(a,b){this.data=b,this.sprite=null,this.branchSp=null,this.branchTxtSp=null,this.init(a),this.colorIndex=0,this.sectors=[],this.isMoving=!1};return h.prototype={init:function(a){_.deepExtend(this,a),this.sprite=new b.Display.Sprite,this.dataLabel.enabled&&(this.branchSp=new b.Display.Sprite,this.branchTxtSp=new b.Display.Sprite),this._configData(),this._configColors()},setX:function(a){this.sprite.context.x=a},setY:function(a){this.sprite.context.y=a},_configData:function(){var b=this;b.total=0,b.currentAngle=0,b.labelFontSize=12*b.pie.boundWidth/800;var c=b.data.data,d=b.pie.r/8;if(c.length&&c.length>0)if(1==c.length)a.mix(c[0],{start:0,end:360,percentage:100,txt:"100%",isMax:!0});else{for(var e=0;e<c.length;e++)b.total+=c[e].y;if(b.total>0){for(var f=0,g=0;g<c.length;g++){g>0&&100*h>c[f].percentage&&(f=g);var h=c[g].y/b.total,i=360*h,j=b.currentAngle+i,k=Math.cos((b.currentAngle+i/2)/180*Math.PI),l=Math.sin((b.currentAngle+i/2)/180*Math.PI),m=b.currentAngle+(j-b.currentAngle)/2,n=function(a){return a>=0&&90>=a?1:a>90&&180>=a?2:a>180&&270>=a?3:a>270&&360>a?4:void 0}(m);a.mix(c[g],{start:b.currentAngle,end:j,outx:d*k,outy:d*l,centerx:(b.pie.r-d)*k,centery:(b.pie.r-d)*l,edgex:(b.pie.r+2*d)*k,edgey:(b.pie.r+2*d)*l,percentage:(100*h).toFixed(1),txt:(100*h).toFixed(1)+"%",quadrant:n,index:g,isMax:!1}),b.currentAngle+=i}c[f].isMax=!0}}},getColorByIndex:function(a,b){return b>=a.length&&(b%=a.length),a[b]},_configColors:function(){var a=["#95CEFF","#434348","#90ED7D","#F7A35C","#8085E9","#F15C80","#E4D354","#8085E8","#8D4653","#91E8E1"];this.colors=this.colors?this.colors:a},draw:function(b){var c=this;c.setX(c.pie.x),c.setY(c.pie.y),c._widget(),b.animation&&(a.each(c.sectors,function(a){a.context.r0=0,a.context.r=0,a.context.startAngle=0,a.context.endAngle=0}),c._hideDataLabel(),c.grow())},grow:function(){function a(){c=requestAnimationFrame(a),g.update()}var b=this,c=null,d=function(){new g.Tween({process:0,r:0,r0:0}).to({process:1,r:b.pie.r,r0:b.pie.r0},800).onUpdate(function(){for(var a=this,c=0;c<b.sectors.length;c++)b.sectors[c].context.r=a.r,b.sectors[c].context.r0=a.r0,b.sectors[c].context.globalAlpha=a.process,0==c?(b.sectors[c].context.startAngle=b.sectors[c].startAngle,b.sectors[c].context.endAngle=b.sectors[c].endAngle*a.process):(b.sectors[c].context.startAngle=b.sectors[c-1].context.endAngle,b.sectors[c].context.endAngle=b.sectors[c].context.startAngle+(b.sectors[c].endAngle-b.sectors[c].startAngle)*a.process)}).onComplete(function(){cancelAnimationFrame(c),b.isMoving=!1,b._showDataLabel()}).start();a()};b.isMoving=!0,d()},_showDataLabel:function(){this.branchSp.context.globalAlpha=1,this.branchTxtSp.context.globalAlpha=1},_hideDataLabel:function(){this.branchSp.context.globalAlpha=0,this.branchTxtSp.context.globalAlpha=0},_showTip:function(){var a=this;a.tipCallback&&a.tipCallback.isshow(!0)},_hideTip:function(){var a=this;a.tipCallback&&a.tipCallback.isshow(!1)},_moveTip:function(a){var b=this;b.tipCallback&&b.tipCallback.position(a)},_redrawTip:function(a){var b=this;b.tipCallback&&b.tipCallback.update(a)},_widget:function(){var e=this,f=e.data.data;if(f.length>0&&e.total>0){e.branchSp&&e.sprite.addChild(e.branchSp),e.branchTxtSp&&e.sprite.addChild(e.branchTxtSp);for(var g=0;g<f.length;g++){e.colorIndex>=e.colors.length&&(e.colorIndex=0);var h=e.getColorByIndex(e.colors,g);if(e.dataLabel.enabled){var i=new d({context:{xStart:f[g].centerx,yStart:f[g].centery,xEnd:f[g].edgex,yEnd:f[g].edgey,lineWidth:1,strokeStyle:h,lineType:"solid"}}),j=new b.Display.Text(f[g].name+" : "+f[g].txt,{context:{x:f[g].edgex,y:f[g].edgey,fontSize:e.labelFontSize,fontWeight:"normal"}}),k=j.getTextWidth(),l=j.getTextHeight(),m=f[g].edgex,n=f[g].edgey,o=2;switch(f[g].quadrant){case 1:m+=o,n-=l/2;break;case 2:m-=k+o,n-=l/2;break;case 3:m-=k+o,n-=l/2;break;case 4:m+=o,n-=l/2}j.context.x=m,j.context.y=n,e.branchSp.addChild(i),e.branchTxtSp.addChild(j)}var p=new c({context:{x:f[g].selected?f[g].outx:0,y:f[g].selected?f[g].outy:0,r0:e.pie.r0,r:e.pie.r,startAngle:f[g].start,endAngle:f[g].end,fillStyle:h,index:f[g].index,lineWidth:e.strokeWidth,strokeStyle:"#fff"},id:"sector"+g});p.__data=f[g],p.__colorIndex=g,p.__dataIndex=g,p.__isSelected=f[g].selected,p.hover(function(a){if(!e.isMoving){var b=a.target,c=b.localToGlobal(a.point);e._redrawTip(this),e._moveTip(c),e._showTip()}},function(){e.isMoving||e._hideTip()}),p.on("mousemove",function(a){var b=a.target,c=b.localToGlobal(a.point);e._moveTip(c)}),p.on("click",function(){var b=this;e.allowPointSelect&&a.each(e.sectors,function(a){a=a.sector,a.__dataIndex!=b.__dataIndex||a.__isSelected?a.__isSelected&&(a.context.x-=f[a.__dataIndex].outx,a.context.y-=f[a.__dataIndex].outy,a.__isSelected=!1):(a.context.x+=f[a.__dataIndex].outx,a.context.y+=f[a.__dataIndex].outy,a.__isSelected=!0)})}),e.sprite.addChild(p),e.sectors.push({sector:p,context:p.context,r:e.pie.r,startAngle:p.context.startAngle,endAngle:p.context.endAngle,color:h})}}}},h},{requires:["canvax/","canvax/shape/Sector","canvax/shape/Line","canvax/shape/Rect","dvix/utils/tools","canvax/animation/Tween","dvix/utils/deep-extend"]});