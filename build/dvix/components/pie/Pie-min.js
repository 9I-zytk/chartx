KISSY.add("dvix/components/pie/Pie",function(a,b,c,d,e,f,g){var h=function(a,b){this.data=b,this.sprite=null,this.branchSp=null,this.branchTxtSp=null,this.init(a),this.colorIndex=0,this.sectors=[],this.isMoving=!1};return h.prototype={init:function(a){_.deepExtend(this,a),this.sprite=new b.Display.Sprite,this.branchSp=new b.Display.Sprite,this.branchTxtSp=new b.Display.Sprite,this._configData(),this._configColors()},setX:function(a){this.sprite.context.x=a},setY:function(a){this.sprite.context.y=a},_configData:function(){var b=this;b.total=0,b.currentAngle=0;var c=b.data.data,d=20;if(c.length&&c.length>0)if(1==c.length)a.mix(c[0],{start:0,end:360,percentage:100,txt:"100%",isMax:!0});else{for(var e=0;e<c.length;e++)b.total+=c[e].y;if(b.total>0){for(var f=0,g=0;g<c.length;g++){g>0&&100*h>c[f].percentage&&(f=g);var h=c[g].y/b.total,i=360*h,j=b.currentAngle+i,k=Math.cos((b.currentAngle+i/2)/180*Math.PI),l=Math.sin((b.currentAngle+i/2)/180*Math.PI),m=b.currentAngle+(j-b.currentAngle)/2,n=function(a){return a>=0&&90>=a?1:a>90&&180>=a?2:a>180&&270>=a?3:a>270&&360>a?4:void 0}(m);a.mix(c[g],{start:b.currentAngle,end:j,outx:d*k,outy:d*l,centerx:(b.pie.r-25)*k,centery:(b.pie.r-25)*l,edgex:(b.pie.r+30)*k,edgey:(b.pie.r+30)*l,percentage:(100*h).toFixed(1),txt:(100*h).toFixed(1)+"%",quadrant:n,index:g,isMax:!1}),b.currentAngle+=i}c[f].isMax=!0}}},getColorByIndex:function(a,b){return b>=a.length&&(b%=a.length),a[b]},_configColors:function(){var a=["#95CEFF","#434348","#90ED7D","#F7A35C","#8085E9","#F15C80","#E4D354","#8085E8","#8D4653","#91E8E1"];this.colors=this.colors?this.colors:a},draw:function(){this.setX(this.pie.x),this.setY(this.pie.y),this._widget(),a.each(this.sectors,function(a){a.context.r=0,a.context.startAngle=0,a.context.endAngle=0})},grow:function(){function a(){c=requestAnimationFrame(a),g.update()}var b=this,c=null,d=function(){new g.Tween({alpha:0,r:0}).to({alpha:1,r:b.pie.r},800).onUpdate(function(){var a=this;b.sprite.context.globalAlpha=this.alpha;for(var c=0;c<b.sectors.length;c++)b.sectors[c].context.r=a.r,0==c?(b.sectors[c].context.startAngle=b.sectors[c].startAngle,b.sectors[c].context.endAngle=b.sectors[c].endAngle*a.alpha):(b.sectors[c].context.startAngle=b.sectors[c-1].context.endAngle,b.sectors[c].context.endAngle=b.sectors[c].context.startAngle+(b.sectors[c].endAngle-b.sectors[c].startAngle)*a.alpha)}).onComplete(function(){cancelAnimationFrame(c),b.isMoving=!1}).start();a()};b.isMoving=!0,d()},_showTip:function(){var a=this;a.pie&&a.pie.tipCallback&&a.pie.tipCallback.isshow(!0)},_hideTip:function(){var a=this;a.pie&&a.pie.tipCallback&&a.pie.tipCallback.isshow(!1)},_moveTip:function(a){var b=this;b.pie&&b.pie.tipCallback&&b.pie.tipCallback.position(a)},_redrawTip:function(a){var b=this;b.pie&&b.pie.tipCallback&&b.pie.tipCallback.update(a)},_widget:function(){var a=this,e=a.data.data;if(e.length>0&&a.total>0){a.sprite.addChild(a.branchSp),a.sprite.addChild(a.branchTxtSp);for(var f=0;f<e.length;f++){a.colorIndex>=a.colors.length&&(a.colorIndex=0);var g=a.getColorByIndex(a.colors,f),h=new d({context:{xStart:e[f].centerx,yStart:e[f].centery,xEnd:e[f].edgex,yEnd:e[f].edgey,lineWidth:1,strokeStyle:g,lineType:"solid"}}),i=new b.Display.Text(e[f].name+" : "+e[f].txt,{context:{x:e[f].edgex,y:e[f].edgey,fontSize:11,fontWeight:"normal"}}),j=i.getTextWidth(),k=i.getTextHeight(),l=e[f].edgex,m=e[f].edgey,n=10;switch(e[f].quadrant){case 1:l+=n,m-=k/2;break;case 2:l-=j+n,m-=k/2;break;case 3:l-=j+n,m-=k/2;break;case 4:l+=n,m-=k/2}i.context.x=l,i.context.y=m,a.branchSp.addChild(h),a.branchTxtSp.addChild(i);var o=new c({context:{r0:20,r:a.pie.r,startAngle:e[f].start,endAngle:e[f].end,fillStyle:g,index:e[f].index,lineWidth:2,strokeStyle:"#fff"},id:"sector"+f});o.__data=e[f],o.__colorIndex=f,o.__dataIndex=f,o.__isSelected=!1,o.hover(function(b){if(!a.isMoving){var c=b.target,d=c.localToGlobal(b.point);console.log(d.x,d.y),a._redrawTip(this),a._moveTip(d),a._showTip()}},function(){a.isMoving||a._hideTip()}),o.on("mousemove",function(b){var c=b.target,d=c.localToGlobal(b.point);console.log(d.x,d.y),a._moveTip(d)}),o.on("click",function(){this.__isSelected?(this.context.x-=e[this.__dataIndex].outx,this.context.y-=e[this.__dataIndex].outy,this.__isSelected=!1):(this.context.x+=e[this.__dataIndex].outx,this.context.y+=e[this.__dataIndex].outy,this.__isSelected=!0)}),a.sprite.addChild(o),a.sectors.push({sector:o,context:o.context,r:a.pie.r,startAngle:o.context.startAngle,endAngle:o.context.endAngle,color:g})}}}},h},{requires:["canvax/","canvax/shape/Sector","canvax/shape/Line","canvax/shape/Rect","dvix/utils/tools","canvax/animation/Tween","dvix/utils/deep-extend"]});